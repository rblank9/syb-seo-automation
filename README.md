Scheduler and Slack (optional)

Scheduler (weekly digest)

Cloud Scheduler → Create job:
	•	Frequency: 0 13 * * MON
	•	Target: HTTP
	•	URL: https://syb-seo-automation-31032723003.europe-west1.run.app?mode=actions_summary
	•	Auth: OIDC
	•	Service account: a scheduler SA with Cloud Run Invoker

Slack webhook
	•	Store SLACK_WEBHOOK_URL in Secret Manager
	•	In main.py, add a format branch format=slack and POST a simple blocks payload

Looker Studio Integration

---

### Looker Studio Integration

A Looker Studio dashboard is used to visualize and manage the `keyword_actions` table.

#### Purpose
The dashboard allows business users to:
- View SEO action recommendations generated by the automation service.
- Filter by status (`Open`, `In progress`, `Complete`) and priority (`High`, `Medium`, `Low`).
- Track completion progress and overdue tasks.
- Compare impressions before and after actions are taken.

#### Setup Steps
1. **Data Source**
   - Connect Looker Studio to the BigQuery table `shield-your-body.gsc_export.keyword_actions`.
   - Use `created_at` as the *Date Range Dimension*.
   - Refresh fields after new schema updates to ensure filters populate.

2. **Controls**
   - Add drop-down filters for `status` and `priority`.
   - Add a date range control and make it **report-level** (so it applies to all pages).
   - Default date range: custom range from *Today minus 10000 days* to *Today* (simulates "All Time").
   - Enable *Allow viewer to change date range*.

3. **Visuals**
   - Table of actions showing: `query`, `recommended_action`, `status`, `priority`, `assigned_to`, `created_at`, `due_date`, `impression_change`.
   - Bar chart summarizing actions by `priority`.
   - KPI cards for total open, completed, and overdue actions.

4. **Behavior**
   - Global date control from Page 1 affects all charts when each chart’s date range dimension is set to `created_at`.
   - Color cues highlight overdue or high-priority work.

#### Example Metrics
- **Completion Rate:** ratio of completed to total actions.
- **Average Days Open:** average time between `created_at` and current date for open items.
- **Priority Breakdown:** counts of open actions per priority.

---

This documents the Looker Studio component of the SEO automation system.

Data hygiene
	•	Partition keyword_actions by created_date and cluster by keyword, action_type
	•	Inside the procedure, prevent duplicates with MERGE on (keyword, action_type, DATE(created_at))
	•	Normalize timestamps to UTC

Example MERGE:

MERGE `shield-your-body.gsc_export.keyword_actions` T
USING src S
ON T.keyword = S.keyword
AND T.action_type = S.action_type
AND DATE(T.created_at) = DATE(S.created_at)
WHEN NOT MATCHED THEN
  INSERT (keyword, action_type, priority, status, assigned_to)
  VALUES (S.keyword, S.action_type, S.priority, 'open', S.assigned_to);

Troubleshooting
	1.	HTTP 503 from Cloud Run
	•	Usually no process listening on $PORT. With buildpacks, ensure:
	•	requirements.txt exists at repo root
	•	functions-framework is in requirements
	•	main.py imports functions_framework
	•	A Flask app is defined or you pass --target=hello_http and the handler exists
	2.	DefaultCredentialsError locally
	•	Run gcloud auth application-default login
	3.	BigQuery Forbidden when calling procedure
	•	Add BigQuery Data Editor on dataset gsc_export to the runtime service account
	4.	GPT says “external service unavailable” but curl works
	•	The GPT-side endpoint URL is stale. Use https://syb-seo-automation-31032723003.europe-west1.run.app

Versioning and change control
	•	Branch: main auto-deploys to production via Cloud Run
	•	Commit messages should be imperative and scoped, e.g.:
	•	feat(actions): weekly digest formatter
	•	fix(trend): guard for missing previous snapshot
	•	chore(deploy): bump functions-framework 3.x

License

Proprietary. Copyright © Shield Your Body.
